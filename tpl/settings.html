{*<!--CitizenAir is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

CitizenAir is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with CitizenAir.  If not, see <http://www.gnu.org/licenses/>.-->
*}
{include="header"}
<main class="settings">
    {if="!empty($login)"}
        {if="$configured == 0"}<p>Choisissez le mot de passe à utiliser pour protéger les préférences.</p>{/if}
        <form method="post" action="?settings=">
            <p><label for="password">Mot de passe{if="$configured == 0"} (apparaîtra en clair){/if}&nbsp;: </label><input {if="$configured == 1"}type="password"{else}type="text"{/if} name="password" id="password"/></p>
            <p><input type="submit" value="{if="$configured == 1"}Connexion{else}Enregistrer{/if}"/></p>
        </form>
    {else}
        {if="$settings === false"}
            <p><a href="?settings=logout">Déconnexion</a></p>
            <h2>Liste des capteurs actuellement autorisés</h2>
            <p><a href="?settings=add_sensor">Ajouter un capteur</a></p>
            {if="empty($api_keys)"}
                <p>Aucun capteur disponible.</p>
            {else}
                <table>
                    <tr>
                        <th>Nom</th>
                        <th>Clé</th>
                        <th>Couleur</th>
                        <th>Modifier</th>
                        <th>Supprimer</th>
                    </tr>
                    {loop="$api_keys"}
                        <tr>
                            <td>{function="htmlspecialchars($value['name'])"}</td>
                            <td>{function="htmlspecialchars($key)"}</td>
                            <td>{function="htmlspecialchars($value['color'])"}</td>
                            <td><a href="?settings=edit_sensor&amp;key={function="htmlspecialchars($key)"}">Modifier</a></td>
                            <td><a href="?settings=delete_sensor&amp;key={function="htmlspecialchars($key)"}" onclick="return confirm('Supprimer ce capteur supprimera toutes les mesures associées. Continuer ?');">Supprimer</a></td>
                        </tr>
                    {/loop}
                </table>
            {/if}

            <h2>Liste des types de mesure disponibles</h2>
            <p><a href="?settings=add_type">Ajouter un type</a></p>
            {if="empty($types)"}
                <p>Aucun type disponible.</p>
            {else}
                <table>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Unité</th>
                        <th>Seuil 1</th>
                        <th>Seuil 2</th>
                        <th>Seuil 3</th>
                        <th>Validité spatiale</th>
                        <th>Opacité réduite après</th>
                        <th>Opacité min. après</th>
                        <th>Description</th>
                        <th>Modifier</th>
                        <th>Supprimer</th>
                    </tr>
                    {loop="$types"}
                        <tr>
                            <td>{function="htmlspecialchars($key)"}</td>
                            <td>{$value['name']}</td>
                            <td>{$value['unit']}</td>
                            <td>{function="htmlspecialchars($value['threshold_1'])"}</td>
                            <td>{function="htmlspecialchars($value['threshold_2'])"}</td>
                            <td>{function="htmlspecialchars($value['threshold_3'])"}</td>
                            <td>{function="htmlspecialchars($value['spatial_validity'])"}m</td>
                            <td>{function="htmlspecialchars($value['start_decrease'])"}s</td>
                            <td>{function="htmlspecialchars($value['fully_gone'])"}s</td>
                            <td>{$value['description']}</td>
                            <td><a href="?settings=edit_type&amp;id={function="htmlspecialchars($key)"}">Modifier</a></td>
                            <td><a href="?settings=delete_type&amp;id={function="htmlspecialchars($key)"}" onclick="return confirm('Supprimer ce type supprimera toutes les mesures associées. Continuer ?');">Supprimer</a></td>
                        </tr>
                    {/loop}
                </table>
            {/if}

            <h2 id="available_measurements">Mesures disponibles</h2>
            {if="empty($data)"}
                <p>Aucune mesure disponible.</p>
            {else}
                <table>
                    <tr>
                        <th>Type <a href="?settings=&amp;sort=type&amp;order=desc#available_measurements">↑</a><a href="?settings=&amp;sort=type&amp;order=asc#available_measurements">↓</a></th>
                        <th>Mesure <a href="?settings=&amp;sort=value&amp;order=desc#available_measurements">↑</a><a href="?settings=&amp;sort=value&amp;order=asc#available_measurements">↓</a></th>
                        <th>Timestamp <a href="?settings=&amp;sort=timestamp&amp;order=desc#available_measurements">↑</a><a href="?settings=&amp;sort=timestamp&amp;order=asc#available_measurements">↓</a></th>
                        <th>Longitude <a href="?settings=&amp;sort=longitude&amp;order=desc#available_measurements">↑</a><a href="?settings=&amp;sort=longitude&amp;order=asc#available_measurements">↓</a></th>
                        <th>Latitude <a href="?settings=&amp;sort=latitude&amp;order=desc#available_measurements">↑</a><a href="?settings=&amp;sort=latitude&amp;order=asc#available_measurements">↓</a></th>
                        <th>Capteur <a href="?settings=&amp;sort=sensor&amp;order=desc#available_measurements">↑</a><a href="?settings=&amp;sort=sensor&amp;order=asc#available_measurements">↓</a></th>
                        <th>Supprimer</th>
                    </tr>
                    {loop="$data"}
                        <tr>
                            <td>{$types[$value['type']]['name']}</td>
                            <td>{function="htmlspecialchars($value['value']).$types[$value['type']]['unit']"}</td>
                            <td>{function="date('d/m/Y à H:i', $value['timestamp'])"}</td>
                            <td>{function="htmlspecialchars($value['longitude'])"}</td>
                            <td>{function="htmlspecialchars($value['latitude'])"}</td>
                            <td>{function="htmlspecialchars($value['sensor'])"}</td>
                            <td><a href="?settings=delete_measurement&amp;id={$key}&amp;sensor={$sensor}">Supprimer</a></td>
                        </tr>
                    {/loop}
                </table>
            {/if}
        {elseif="$settings == 'add_sensor' || ($settings == 'edit_sensor' && !empty($sensor_key))"}
            <form method="post" action="?settings=">
                <p><label for="sensor">Nom&nbsp;: </label><input type="text" name="sensor" id="sensor" {if="!empty($sensor_key)"}value="{function="htmlspecialchars($api_keys[$sensor_key]['name'])"}"{/if}/></p>
                <p>
                    <label for="color">Couleur&nbsp;: </label>
                    <input type="text" name="color" id="color" {if="!empty($sensor_key)"}value="{function="htmlspecialchars($api_keys[$sensor_key]['color'])"}"{/if}/>
                </p>
                <div id="colorpicker">
                    <canvas id="picker" width="300" height="300"></canvas>
                </div>
                <p>
                    <input type="submit" value="Sauver"/> ou <a href="?settings=">Retour</a>
                    {if="!empty($sensor_key)"}<input type="hidden" name="key" value="{function="htmlspecialchars($sensor_key)"}"/>{/if}
                </p>
            </form>
        {elseif="$settings == 'add_type' || ($settings == 'edit_type' && !empty($type_id))"}
            <form method="post" action="?settings=">
                <p><label for="id">ID&nbsp;: </label><input types="text" name="id" id="id" {if="!empty($type_id)"}value="{function="htmlspecialchars($type_id)"}"{/if}/></p>
                <p><label for="name">Nom (HTML possible)&nbsp;: </label><input types="text" name="name" id="name" {if="!empty($type_id)"}value="{$types[$type_id]['name']}"{/if}/></p>
                <p><label for="unit">Unité (HTML possible)&nbsp;: </label><input types="text" name="unit" id="unit" {if="!empty($type_id)"}value="{$types[$type_id]['unit']}"{/if}/></p>
                <p><label for="threshold_1">threshold 1&nbsp;: </label><input types="number" name="threshold_1" id="threshold_1" {if="!empty($type_id)"}value="{function="htmlspecialchars($types[$type_id]['threshold_1'])"}"{/if}/></p>
                <p><label for="threshold_2">threshold 2&nbsp;: </label><input types="number" name="threshold_2" id="threshold_2" {if="!empty($type_id)"}value="{function="htmlspecialchars($types[$type_id]['threshold_2'])"}"{/if}/></p>
                <p><label for="threshold_3">threshold 3&nbsp;: </label><input types="number" name="threshold_3" id="threshold_3" {if="!empty($type_id)"}value="{function="htmlspecialchars($types[$type_id]['threshold_3'])"}"{/if}/></p>
                <p><label for="spatial_validity">Validité spatiale (diamètre, en mètres)&nbsp;: </label><input types="number" name="spatial_validity" id="spatial_validity" {if="!empty($type_id)"}value="{function="htmlspecialchars($types[$type_id]['spatial_validity'])"}"{/if}/></p>
                <p><label for="start_decrease">Durée avant baisse de l'opacité (en secondes)&nbsp;: </label><input types="number" name="start_decrease" id="start_decrease" {if="!empty($type_id)"}value="{function="htmlspecialchars($types[$type_id]['start_decrease'])"}"{/if}/></p>
                <p><label for="fully_gone">Durée avant opacité min. (en secondes)&nbsp;: </label><input types="number" name="fully_gone" id="fully_gone" {if="!empty($type_id)"}value="{function="htmlspecialchars($types[$type_id]['fully_gone'])"}"{/if}/></p>
                <p><label for="description">Description (HTML possible)&nbsp;: </label><textarea name="description" id="description">{if="!empty($type_id)"}{function="br2nl($types[$type_id]['description'])"}{/if}</textarea></p>
                <p>
                    <input type="submit" value="Sauver"/>{if="!empty($type_id)"}<input type="hidden" name="old_id" value="{$type_id}"/>{/if} ou <a href="?settings=">Retour</a>
                </p>
            </form>
        {/if}
    {/if}
</main>
{include="footer"}
